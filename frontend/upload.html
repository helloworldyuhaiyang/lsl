<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Test</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 720px;
      margin: 24px auto;
      padding: 0 16px;
    }

    label,
    input,
    button {
      display: block;
      margin-bottom: 10px;
    }

    #progressWrap {
      width: 100%;
      height: 16px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    #progressBar {
      height: 100%;
      width: 0%;
      background: #2e7d32;
      transition: width 0.15s linear;
    }

    pre {
      background: #f7f7f7;
      padding: 12px;
      border-radius: 6px;
      min-height: 120px;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <h2>文件上传测试</h2>

  <label>API Base</label>
  <input id="apiBase" value="http://127.0.0.1:8000" />

  <label>category</label>
  <input id="category" value="listening" />

  <label>entity_id</label>
  <input id="entityId" value="test_user" />

  <label>文件</label>
  <input id="fileInput" type="file" />

  <button id="uploadBtn" type="button">上传</button>

  <div id="progressWrap">
    <div id="progressBar"></div>
  </div>

  <pre id="log"></pre>

  <script>
    const logEl = document.getElementById("log");
    const progressBar = document.getElementById("progressBar");
    const uploadBtn = document.getElementById("uploadBtn");

    function log(msg) {
      logEl.textContent += `${msg}\n`;
    }

    function setProgress(percent) {
      progressBar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
    }

    async function getUploadURL(apiBase, category, entityId, filename, contentType) {
      const params = new URLSearchParams({
        category,
        entity_id: entityId,
        filename,
        content_type: contentType,
      });

      const resp = await fetch(`${apiBase}/assets/upload-url?${params.toString()}`, {
        method: "POST",
      });

      if (!resp.ok) {
        throw new Error(`生成上传地址失败: HTTP ${resp.status} ${await resp.text()}`);
      }
      return resp.json();
    }

    function uploadByXHR(uploadURL, file, contentType) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("PUT", uploadURL, true);
        xhr.setRequestHeader("Content-Type", contentType);

        xhr.upload.onprogress = (evt) => {
          if (evt.lengthComputable) {
            setProgress((evt.loaded / evt.total) * 100);
          }
        };

        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            resolve();
          } else {
            reject(new Error(`上传失败: HTTP ${xhr.status}`));
          }
        };

        xhr.onerror = () => reject(new Error("上传失败: 网络错误"));
        xhr.send(file);
      });
    }

    uploadBtn.addEventListener("click", async () => {
      logEl.textContent = "";
      setProgress(0);

      const apiBase = document.getElementById("apiBase").value.trim().replace(/\/$/, "");
      const category = document.getElementById("category").value.trim();
      const entityId = document.getElementById("entityId").value.trim();
      const file = document.getElementById("fileInput").files[0];

      if (!apiBase || !category || !entityId || !file) {
        alert("请填写 api/category/entity_id 并选择文件");
        return;
      }

      const contentType = file.type || "application/octet-stream";
      uploadBtn.disabled = true;

      try {
        log(`选中文件: ${file.name} (${file.size} bytes)`);
        const data = await getUploadURL(apiBase, category, entityId, file.name, contentType);
        log("拿到 upload_url:");
        log(JSON.stringify(data, null, 2));

        await uploadByXHR(data.upload_url, file, contentType);
        setProgress(100);
        log("上传完成");
        log(`asset_url: ${data.asset_url}`);
      } catch (err) {
        log(err.message || String(err));
      } finally {
        uploadBtn.disabled = false;
      }
    });
  </script>
</body>

</html>
